version: "3.8"

services:
  prometheus:
    image: prom/prometheus:v2.35.0
    user: root
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    volumes:
      - prometheus:/prometheus
      - etc_prometheus:/etc/prometheus
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 9090:9090
    networks:
      - traefik_public
      - monitoring
    deploy:
      labels:
        traefik.enable: "true"
        traefik.http.routers.prometheus.rule: "Host(`prometheus.${DOMAIN:?}`)"
        traefik.http.routers.prometheus.entrypoints: "websecure"
        traefik.http.routers.prometheus.tls.certresolver: "letsencrypt"
        traefik.http.services.prometheus.loadbalancer.server.port: 9090
        traefik.http.routers.prometheus.service: "prometheus"
        traefik.http.routers.prometheus.middlewares: prometheus-auth
        traefik.http.middlewares.prometheus-auth.forwardauth.address: http://cloudflare-auth:8080/auth/${CLOUDFLARE_AUTH_AUD:?}
        
volumes:
  prometheus:
    driver_opts:
      type: nfs
      o: addr=${NFS_SERVER:?},nfsvers=4
      device: :/prometheus_prometheus
  etc_prometheus:
    driver_opts:
      type: nfs
      o: addr=${NFS_SERVER:?},nfsvers=4
      device: :/prometheus_etc_prometheus

networks:
  traefik_public:
    external: true
  monitoring:
    external: true
    
